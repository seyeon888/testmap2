<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자전거 대여소 지도</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <script>
        // Google Maps API 키 설정 (선택사항)
        // Google Maps를 사용하려면 아래 주석을 해제하고 YOUR_API_KEY를 실제 키로 변경하세요
        // var GOOGLE_MAPS_API_KEY = 'YOUR_API_KEY';
        
        // Google Maps 스타일 정의
        var mapStyle = [
            {
                "featureType": "all",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "weight": "2.00"
                    }
                ]
            },
            {
                "featureType": "all",
                "elementType": "geometry.stroke",
                "stylers": [
                    {
                        "color": "#9c9c9c"
                    }
                ]
            },
            {
                "featureType": "all",
                "elementType": "labels.text",
                "stylers": [
                    {
                        "visibility": "on"
                    }
                ]
            },
            {
                "featureType": "landscape",
                "elementType": "all",
                "stylers": [
                    {
                        "color": "#f2f2f2"
                    }
                ]
            },
            {
                "featureType": "landscape",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#ffffff"
                    }
                ]
            },
            {
                "featureType": "landscape.man_made",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#ffffff"
                    }
                ]
            },
            {
                "featureType": "poi",
                "elementType": "all",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
            },
            {
                "featureType": "road",
                "elementType": "all",
                "stylers": [
                    {
                        "saturation": -100
                    },
                    {
                        "lightness": 45
                    }
                ]
            },
            {
                "featureType": "road",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#eeeeee"
                    }
                ]
            },
            {
                "featureType": "road",
                "elementType": "labels.text.fill",
                "stylers": [
                    {
                        "color": "#7b7b7b"
                    }
                ]
            },
            {
                "featureType": "road",
                "elementType": "labels.text.stroke",
                "stylers": [
                    {
                        "color": "#ffffff"
                    }
                ]
            },
            {
                "featureType": "road.highway",
                "elementType": "all",
                "stylers": [
                    {
                        "visibility": "simplified"
                    }
                ]
            },
            {
                "featureType": "road.arterial",
                "elementType": "labels.icon",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
            },
            {
                "featureType": "transit",
                "elementType": "all",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
            },
            {
                "featureType": "water",
                "elementType": "all",
                "stylers": [
                    {
                        "color": "#46bcec"
                    },
                    {
                        "visibility": "on"
                    }
                ]
            },
            {
                "featureType": "water",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#c8d7d4"
                    }
                ]
            },
            {
                "featureType": "water",
                "elementType": "labels.text.fill",
                "stylers": [
                    {
                        "color": "#070707"
                    }
                ]
            },
            {
                "featureType": "water",
                "elementType": "labels.text.stroke",
                "stylers": [
                    {
                        "color": "#ffffff"
                    }
                ]
            }
        ];

        // 지도 초기화 (한국 중심)
        var map = L.map('map').setView([36.5, 127.5], 7);

        // Google Maps 스타일과 유사한 밝고 깔끔한 스타일의 타일 사용
        // 제공된 스타일은 밝은 배경, 회색 도로, 파란색 물을 특징으로 하므로
        // CartoDB Positron이 가장 유사한 스타일입니다
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap contributors © CARTO',
            subdomains: 'abcd',
            maxZoom: 19
        }).addTo(map);
        
        // 지도가 로드된 후 데이터 로드
        map.whenReady(function() {
            console.log('지도 로드 완료');
            loadMarkers();
        });
        
        function loadMarkers() {
        
        // Google Maps API 키가 있는 경우 아래 주석을 해제하여 Google Maps 스타일을 사용할 수 있습니다
        /*
        if (typeof GOOGLE_MAPS_API_KEY !== 'undefined' && GOOGLE_MAPS_API_KEY !== 'YOUR_API_KEY') {
            // Google Maps API 스크립트 동적 로드
            var script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=' + GOOGLE_MAPS_API_KEY + '&libraries=geometry&callback=initGoogleMap';
            document.head.appendChild(script);
            
            // Leaflet Google Mutant Plugin 로드
            var mutantScript = document.createElement('script');
            mutantScript.src = 'https://unpkg.com/leaflet.gridlayer.googlemutant@latest/dist/Leaflet.GoogleMutant.js';
            mutantScript.onload = function() {
                window.initGoogleMap = function() {
                    var googleLayer = L.gridLayer.googleMutant({
                        type: 'roadmap',
                        styles: mapStyle
                    });
                    map.removeLayer(map._layers[Object.keys(map._layers)[0]]); // 기존 타일 제거
                    googleLayer.addTo(map);
                };
            };
            document.head.appendChild(mutantScript);
        }
        */

            // data.json 파일 로드
            fetch('data.json')
            .then(response => {
                if (!response.ok) {
                    throw new Error('HTTP error! status: ' + response.status);
                }
                return response.json();
            })
            .then(data => {
                console.log('데이터 로드 성공:', data.length, '개 항목');
                
                // 모든 마커를 저장할 배열
                var markers = [];
                var invalidCount = 0;
                
                // 각 위치에 마커 추가
                data.forEach(function(location, index) {
                    // 위도와 경도 확인 (업데이트된 JSON 구조: lat, lng 사용)
                    var lat = parseFloat(location.lat);
                    var lng = parseFloat(location.lng);
                    
                    // 유효한 좌표인지 확인 (0이 아니고, 숫자이고, 유효한 범위 내)
                    if (lat && lng && !isNaN(lat) && !isNaN(lng) && 
                        lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
                        // 팝업 내용 구성
                        var popupContent = '<div class="info">';
                        popupContent += '<strong>' + (location.FCLTY_NM || '자전거 대여소') + '</strong>';
                        if (location.FCLTY_ROAD_NM_ADDR) {
                            popupContent += '<br>' + location.FCLTY_ROAD_NM_ADDR;
                        }
                        if (location.CTPRVN_NM && location.SIGNGU_NM) {
                            popupContent += '<br><small>' + location.CTPRVN_NM + ' ' + location.SIGNGU_NM + '</small>';
                        }
                        popupContent += '</div>';
                        
                        // 마커 생성
                        var marker = L.marker([lat, lng])
                            .addTo(map)
                            .bindPopup(popupContent);
                        
                        markers.push(marker);
                    } else {
                        invalidCount++;
                        if (index < 5) { // 처음 5개만 로그
                            console.warn('유효하지 않은 좌표:', index, location);
                        }
                    }
                });

                console.log('유효한 마커:', markers.length, '개');
                console.log('유효하지 않은 데이터:', invalidCount, '개');

                // 모든 마커를 포함하는 범위 계산
                if (markers.length > 0) {
                    var group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                    console.log('지도 범위 조정 완료');
                } else {
                    console.error('표시할 마커가 없습니다. 데이터를 확인해주세요.');
                    alert('표시할 마커가 없습니다. 브라우저 콘솔을 확인해주세요.');
                }
            })
            .catch(error => {
                console.error('데이터를 불러오는 중 오류가 발생했습니다:', error);
                alert('데이터를 불러올 수 없습니다. data.json 파일을 확인해주세요.\n에러: ' + error.message);
            });
        }
    </script>
</body>
</html>

