<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>자전거 대여소 지도</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    
    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
          crossorigin=""/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
          crossorigin=""/>
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    
    <!-- Leaflet MarkerCluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"
            crossorigin=""></script>
    
    <!-- Turf.js (GeoJSON 병합 및 단순화 용도) -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"
            crossorigin="anonymous"></script>
    
    <script>
        // Google Maps API 키 설정 (선택사항)
        // Google Maps를 사용하려면 아래 주석을 해제하고 YOUR_API_KEY를 실제 키로 변경하세요
        // var GOOGLE_MAPS_API_KEY = 'YOUR_API_KEY';
        
        // Google Maps 스타일 정의
        var mapStyle = [
            {
                "featureType": "all",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "weight": "2.00"
                    }
                ]
            },
            {
                "featureType": "all",
                "elementType": "geometry.stroke",
                "stylers": [
                    {
                        "color": "#9c9c9c"
                    }
                ]
            },
            {
                "featureType": "all",
                "elementType": "labels.text",
                "stylers": [
                    {
                        "visibility": "on"
                    }
                ]
            },
            {
                "featureType": "landscape",
                "elementType": "all",
                "stylers": [
                    {
                        "color": "#f2f2f2"
                    }
                ]
            },
            {
                "featureType": "landscape",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#ffffff"
                    }
                ]
            },
            {
                "featureType": "landscape.man_made",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#ffffff"
                    }
                ]
            },
            {
                "featureType": "poi",
                "elementType": "all",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
            },
            {
                "featureType": "road",
                "elementType": "all",
                "stylers": [
                    {
                        "saturation": -100
                    },
                    {
                        "lightness": 45
                    }
                ]
            },
            {
                "featureType": "road",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#eeeeee"
                    }
                ]
            },
            {
                "featureType": "road",
                "elementType": "labels.text.fill",
                "stylers": [
                    {
                        "color": "#7b7b7b"
                    }
                ]
            },
            {
                "featureType": "road",
                "elementType": "labels.text.stroke",
                "stylers": [
                    {
                        "color": "#ffffff"
                    }
                ]
            },
            {
                "featureType": "road.highway",
                "elementType": "all",
                "stylers": [
                    {
                        "visibility": "simplified"
                    }
                ]
            },
            {
                "featureType": "road.arterial",
                "elementType": "labels.icon",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
            },
            {
                "featureType": "transit",
                "elementType": "all",
                "stylers": [
                    {
                        "visibility": "off"
                    }
                ]
            },
            {
                "featureType": "water",
                "elementType": "all",
                "stylers": [
                    {
                        "color": "#46bcec"
                    },
                    {
                        "visibility": "on"
                    }
                ]
            },
            {
                "featureType": "water",
                "elementType": "geometry.fill",
                "stylers": [
                    {
                        "color": "#c8d7d4"
                    }
                ]
            },
            {
                "featureType": "water",
                "elementType": "labels.text.fill",
                "stylers": [
                    {
                        "color": "#070707"
                    }
                ]
            },
            {
                "featureType": "water",
                "elementType": "labels.text.stroke",
                "stylers": [
                    {
                        "color": "#ffffff"
                    }
                ]
            }
        ];

        // 서울 경계 설정 (대략적인 남서/북동 모서리)
        var seoulBounds = L.latLngBounds(
            [37.413294, 126.734086],
            [37.715133, 127.269311]
        );

        // 지도 초기화 (서울 중심, 서울 경계로 제한)
        var map = L.map('map', {
            maxBounds: seoulBounds,
            maxBoundsViscosity: 1.0,
            minZoom: 10,
            maxZoom: 18,
            zoomControl: true
        }).fitBounds(seoulBounds);
        
        // 마커 클러스터 그룹 변수
        var markerClusterGroup = null;
        var seoulBoundaryLayer = null;
        var seoulMaskLayer = null;
        var seoulBoundaryGeoJsonUrl = 'https://raw.githubusercontent.com/codeforamerica/click_that_hood/master/public/data/seoul.geojson';

        // 서울 시군구 이름 목록
        var seoulDistricts = [
            '강남구','강동구','강북구','강서구','관악구','광진구','구로구','금천구','노원구',
            '도봉구','동대문구','동작구','마포구','서대문구','서초구','성동구','성북구','송파구',
            '양천구','영등포구','용산구','은평구','종로구','중구','중랑구'
        ];
        var normalizedAllowedDistricts = seoulDistricts.map(normalizeDistrictName);

        // 맞춤형 마커 아이콘 (자전거 핀 형태)
        var bikeMarkerIcon = L.divIcon({
            className: '',
            html: '<div class="bike-marker"><div class="bike-marker__inner"></div></div>',
            iconSize: [34, 44],
            iconAnchor: [17, 42],
            popupAnchor: [0, -36],
            tooltipAnchor: [0, -30]
        });

        // Google Maps 스타일과 유사한 밝고 깔끔한 스타일의 타일 사용
        // 제공된 스타일은 밝은 배경, 회색 도로, 파란색 물을 특징으로 하므로
        // CartoDB Positron이 가장 유사한 스타일입니다
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '© OpenStreetMap contributors © CARTO',
            subdomains: 'abcd',
            minZoom: 10,
            maxZoom: 18
        }).addTo(map);
        
        // 지도가 로드된 후 데이터 로드
        map.whenReady(function() {
            console.log('지도 로드 완료');
            loadSeoulBoundary();
            loadMarkers();
        });
        
        function loadSeoulBoundary() {
            fetch(seoulBoundaryGeoJsonUrl)
                .then(function(response) {
                    if (!response.ok) {
                        throw new Error('서울 경계 데이터를 불러오지 못했습니다: ' + response.status);
                    }
                    return response.json();
                })
                .then(function(geojson) {
                    if (seoulBoundaryLayer) {
                        map.removeLayer(seoulBoundaryLayer);
                        seoulBoundaryLayer = null;
                    }
                    var filteredGeojson = filterGeojsonByDistricts(geojson, normalizedAllowedDistricts);
                    var aggregatedGeojson = aggregateDistrictBoundaries(filteredGeojson, normalizedAllowedDistricts);
                    var boundarySource = (aggregatedGeojson && aggregatedGeojson.features && aggregatedGeojson.features.length) ? aggregatedGeojson : filteredGeojson;

                    seoulBoundaryLayer = L.geoJSON(boundarySource, {
                        style: {
                            color: '#ffb703',
                            weight: 2,
                            opacity: 0.9,
                            fillOpacity: 0
                        }
                    }).addTo(map);

                    var boundaryBounds = seoulBoundaryLayer.getBounds();
                    if (boundaryBounds.isValid()) {
                        map.fitBounds(boundaryBounds);
                    }

                    var mergedBoundary = mergeFeaturesForMask(boundarySource);
                    applySeoulMask(mergedBoundary || boundarySource);
                })
                .catch(function(error) {
                    console.error('서울 경계선을 로드하는 중 오류 발생:', error);
                });
        }

        function applySeoulMask(geojson) {
            if (seoulMaskLayer) {
                map.removeLayer(seoulMaskLayer);
                seoulMaskLayer = null;
            }

            var seoulRings = extractSeoulRings(geojson);
            if (!seoulRings.length) {
                return;
            }

            var outerRing = [
                [85, -180],
                [85, 180],
                [-85, 180],
                [-85, -180]
            ];

            seoulMaskLayer = L.polygon([outerRing].concat(seoulRings), {
                color: '#f2f2f2',
                weight: 0,
                fillColor: '#f2f2f2',
                fillOpacity: 1,
                interactive: false
            }).addTo(map);
        }

        function extractSeoulRings(geojson) {
            var rings = [];
            if (!geojson || !geojson.features) {
                return rings;
            }

            geojson.features.forEach(function(feature) {
                var geometry = feature.geometry;
                if (!geometry || !geometry.coordinates) {
                    return;
                }

                if (geometry.type === 'Polygon') {
                    geometry.coordinates.forEach(function(ring) {
                        rings.push(ring.map(function(coord) {
                            return [coord[1], coord[0]];
                        }));
                    });
                } else if (geometry.type === 'MultiPolygon') {
                    geometry.coordinates.forEach(function(polygon) {
                        polygon.forEach(function(ring) {
                            rings.push(ring.map(function(coord) {
                                return [coord[1], coord[0]];
                            }));
                        });
                    });
                }
            });

            return rings;
        }

        function mergeFeaturesForMask(geojson) {
            if (!geojson || !geojson.features || geojson.features.length === 0) {
                return null;
            }

            if (typeof turf === 'undefined' || !turf.union) {
                console.warn('Turf.js가 로드되지 않아 경계 병합을 건너뜁니다.');
                return geojson;
            }

            try {
                var merged = geojson.features[0];
                for (var i = 1; i < geojson.features.length; i++) {
                    merged = turf.union(merged, geojson.features[i]);
                }
                return {
                    type: 'FeatureCollection',
                    features: [merged]
                };
            } catch (error) {
                console.warn('서울 경계를 병합하는 중 오류가 발생했습니다. 원본 데이터를 사용합니다.', error);
                return geojson;
            }
        }

        function filterGeojsonByDistricts(geojson, normalizedWhitelist) {
            if (!geojson || !geojson.features || !geojson.features.length) {
                return geojson;
            }

            var filtered = geojson.features.filter(function(feature) {
                var props = feature.properties || {};
                var candidates = [
                    props.sggnm, props.SGGNM,
                    props.name, props.NAME,
                    props.adm_nm, props.ADM_NM
                ];
                return candidates.some(function(value) {
                    if (!value || typeof value !== 'string') {
                        return false;
                    }
                    var normalized = normalizeDistrictName(value);
                    return normalizedWhitelist.some(function(allowed) {
                        return normalized.indexOf(allowed) !== -1;
                    });
                });
            });

            if (!filtered.length) {
                return geojson;
            }

            return {
                type: 'FeatureCollection',
                features: filtered
            };
        }

        function aggregateDistrictBoundaries(geojson, normalizedWhitelist) {
            if (!geojson || !geojson.features || !geojson.features.length) {
                return geojson;
            }

            if (typeof turf === 'undefined' || !turf.union) {
                console.warn('Turf.js가 없어 구 경계 병합을 건너뜁니다.');
                return geojson;
            }

            var groups = {};
            geojson.features.forEach(function(feature) {
                var districtName = extractDistrictName(feature, normalizedWhitelist);
                if (!districtName) {
                    return;
                }
                if (!groups[districtName]) {
                    groups[districtName] = feature;
                } else {
                    try {
                        groups[districtName] = turf.union(groups[districtName], feature);
                    } catch (error) {
                        console.warn('구 경계 병합 중 오류 발생:', error);
                    }
                }
            });

            var aggregated = Object.keys(groups).map(function(name) {
                var mergedFeature = groups[name];
                if (!mergedFeature || !mergedFeature.geometry) {
                    return null;
                }
                mergedFeature.properties = mergedFeature.properties || {};
                mergedFeature.properties.districtName = name;
                return mergedFeature;
            }).filter(Boolean);

            if (!aggregated.length) {
                return geojson;
            }

            return {
                type: 'FeatureCollection',
                features: aggregated
            };
        }

        function extractDistrictName(feature, normalizedWhitelist) {
            if (!feature || !feature.properties) {
                return null;
            }
            var candidates = [
                feature.properties.sggnm, feature.properties.SGGNM,
                feature.properties.name, feature.properties.NAME,
                feature.properties.adm_nm, feature.properties.ADM_NM
            ];

            for (var i = 0; i < candidates.length; i++) {
                var value = candidates[i];
                if (!value || typeof value !== 'string') {
                    continue;
                }
                var normalized = normalizeDistrictName(value);
                for (var j = 0; j < normalizedWhitelist.length; j++) {
                    var allowed = normalizedWhitelist[j];
                    if (normalized.indexOf(allowed) !== -1) {
                        return seoulDistricts[j];
                    }
                }
            }
            return null;
        }

        function normalizeDistrictName(name) {
            if (!name) {
                return '';
            }
            return String(name).replace(/\s+/g, '').replace(/[^가-힣A-Za-z0-9]/g, '');
        }

        function loadMarkers() {
        
        // Google Maps API 키가 있는 경우 아래 주석을 해제하여 Google Maps 스타일을 사용할 수 있습니다
        /*
        if (typeof GOOGLE_MAPS_API_KEY !== 'undefined' && GOOGLE_MAPS_API_KEY !== 'YOUR_API_KEY') {
            // Google Maps API 스크립트 동적 로드
            var script = document.createElement('script');
            script.src = 'https://maps.googleapis.com/maps/api/js?key=' + GOOGLE_MAPS_API_KEY + '&libraries=geometry&callback=initGoogleMap';
            document.head.appendChild(script);
            
            // Leaflet Google Mutant Plugin 로드
            var mutantScript = document.createElement('script');
            mutantScript.src = 'https://unpkg.com/leaflet.gridlayer.googlemutant@latest/dist/Leaflet.GoogleMutant.js';
            mutantScript.onload = function() {
                window.initGoogleMap = function() {
                    var googleLayer = L.gridLayer.googleMutant({
                        type: 'roadmap',
                        styles: mapStyle
                    });
                    map.removeLayer(map._layers[Object.keys(map._layers)[0]]); // 기존 타일 제거
                    googleLayer.addTo(map);
                };
            };
            document.head.appendChild(mutantScript);
        }

        */

            // data.json 파일 로드 (CORS 문제 해결: fetch와 XMLHttpRequest 모두 시도)
            function processData(data) {
                console.log('데이터 로드 성공:', data.length, '개 항목');
                
                // 모든 마커를 저장할 배열
                var markers = [];
                var invalidCount = 0;
                
                // 각 위치에 마커 추가
                data.forEach(function(location, index) {
                    // 위도와 경도 확인 (업데이트된 JSON 구조: lat, lng 사용)
                    var lat = parseFloat(location.lat);
                    var lng = parseFloat(location.lng);
                    
                    // 유효한 좌표인지 확인 (0이 아니고, 숫자이고, 유효한 범위 내)
                    if (lat && lng && !isNaN(lat) && !isNaN(lng) && 
                        lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {

                        var isSeoul = false;
                        if (location.CTPRVN_NM && location.CTPRVN_NM.indexOf('서울') !== -1) {
                            isSeoul = true;
                        } else if (location.FCLTY_ROAD_NM_ADDR && location.FCLTY_ROAD_NM_ADDR.indexOf('서울특별시') !== -1) {
                            isSeoul = true;
                        } else if (location.SIGNGU_NM && seoulDistricts.indexOf(location.SIGNGU_NM) !== -1) {
                            isSeoul = true;
                        } else if (seoulBounds.contains([lat, lng])) {
                            isSeoul = true;
                        }

                        if (!isSeoul) {
                            return;
                        }
                        
                        // Tooltip 내용 구성 (마우스 오버 시 표시)
                        var tooltipContent = '<div style="font-weight: bold; margin-bottom: 3px;">' + 
                            (location.FCLTY_NM || '자전거 대여소') + '</div>';
                        if (location.SIGNGU_NM) {
                            tooltipContent += '<div style="font-size: 12px; color: #ddd;">' + location.SIGNGU_NM + '</div>';
                        }
                        
                        // Popup 내용 구성 (클릭 시 표시 - 더 자세한 정보)
                        var popupContent = '<div class="info">';
                        popupContent += '<strong style="font-size: 16px; display: block; margin-bottom: 8px;">' + 
                            (location.FCLTY_NM || '자전거 대여소') + '</strong>';
                        
                        if (location.LCLAS_NM) {
                            popupContent += '<div style="margin-bottom: 5px;"><span style="color: #666;">시설분류:</span> ' + 
                                location.LCLAS_NM + '</div>';
                        }
                        
                        if (location.FCLTY_ROAD_NM_ADDR) {
                            popupContent += '<div style="margin-bottom: 5px;"><span style="color: #666;">주소:</span><br>' + 
                                location.FCLTY_ROAD_NM_ADDR + '</div>';
                        }
                        
                        if (location.SIGNGU_NM) {
                            popupContent += '<div style="margin-bottom: 5px;"><span style="color: #666;">시군구:</span> ' + 
                                location.SIGNGU_NM + '</div>';
                        }
                        
                        if (location.LEGALDONG_NM) {
                            popupContent += '<div style="margin-bottom: 5px;"><span style="color: #666;">법정동:</span> ' + 
                                location.LEGALDONG_NM + '</div>';
                        }
                        
                        if (location.BULD_NM) {
                            popupContent += '<div style="margin-bottom: 5px;"><span style="color: #666;">건물명:</span> ' + 
                                location.BULD_NM + '</div>';
                        }
                        
                        if (location.CTPRVN_NM) {
                            popupContent += '<div style="margin-bottom: 5px;"><span style="color: #666;">시도:</span> ' + 
                                location.CTPRVN_NM + '</div>';
                        }
                        
                        if (location.MLSFC_NM) {
                            popupContent += '<div style="margin-bottom: 5px;"><span style="color: #666;">상세분류:</span> ' + 
                                location.MLSFC_NM + '</div>';
                        }
                        
                        if (location.ADDR_ENG_NM) {
                            popupContent += '<div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; font-size: 12px; color: #888;">' + 
                                location.ADDR_ENG_NM + '</div>';
                        }
                        
                        popupContent += '</div>';
                        
                        // 마커 생성 (아직 지도에 추가하지 않음)
                        var marker = L.marker([lat, lng], { icon: bikeMarkerIcon })
                            .bindTooltip(tooltipContent, {
                                permanent: false,
                                direction: 'top',
                                className: 'custom-tooltip',
                                offset: [0, -10]
                            })
                            .bindPopup(popupContent, {
                                maxWidth: 300
                            });
                        
                        markers.push(marker);
                    } else {
                        invalidCount++;
                        if (index < 5) { // 처음 5개만 로그
                            console.warn('유효하지 않은 좌표:', index, location);
                        }
                    }
                });

                console.log('유효한 마커:', markers.length, '개');
                console.log('유효하지 않은 데이터:', invalidCount, '개');

                // 기존 클러스터 그룹 제거
                if (markerClusterGroup) {
                    map.removeLayer(markerClusterGroup);
                    markerClusterGroup = null;
                }

                // 마커 개수에 따라 클러스터링 또는 개별 표시
                if (markers.length > 0) {
                    if (markers.length >= 20) {
                        // 20개 이상: 클러스터링 활성화
                        console.log('마커 클러스터링 활성화 (20개 이상)');
                        markerClusterGroup = L.markerClusterGroup({
                            showCoverageOnHover: false,
                            maxClusterRadius: 85,
                            spiderfyOnMaxZoom: false,
                            disableClusteringAtZoom: 15,
                            removeOutsideVisibleBounds: true,
                            iconCreateFunction: function(cluster) {
                                var count = cluster.getChildCount();
                                var sizeClass = 'cluster-small';
                                if (count >= 50) {
                                    sizeClass = 'cluster-large';
                                } else if (count >= 20) {
                                    sizeClass = 'cluster-medium';
                                }
                                return L.divIcon({
                                    html: '<div class="bike-cluster ' + sizeClass + '"><span>' + count + '</span></div>',
                                    className: '',
                                    iconSize: [48, 48],
                                    iconAnchor: [24, 24]
                                });
                            }
                        });
                        markerClusterGroup.addLayers(markers);
                        map.addLayer(markerClusterGroup);
                    } else {
                        // 20개 미만: 개별 마커 표시
                        console.log('개별 마커 표시 (20개 미만)');
                        markers.forEach(function(marker) {
                            marker.addTo(map);
                        });
                    }

                    // 모든 마커를 포함하는 범위 계산
                    var group = new L.featureGroup(markers);
                    map.fitBounds(group.getBounds().pad(0.1));
                    console.log('지도 범위 조정 완료');
                } else {
                    console.error('표시할 마커가 없습니다. 데이터를 확인해주세요.');
                    alert('표시할 마커가 없습니다. 브라우저 콘솔을 확인해주세요.');
                }
            }
            
            function handleError(error, method) {
                console.error('데이터를 불러오는 중 오류가 발생했습니다 (' + method + '):', error);
                var errorMsg = '데이터를 불러올 수 없습니다.\n\n';
                errorMsg += '가능한 원인:\n';
                errorMsg += '1. CORS 정책 (file:// 프로토콜 사용 시)\n';
                errorMsg += '2. data.json 파일이 같은 폴더에 없음\n';
                errorMsg += '3. 파일 경로 오류\n\n';
                errorMsg += '해결 방법:\n';
                errorMsg += '로컬 웹 서버를 사용하세요:\n';
                errorMsg += '- Python: python -m http.server 8000\n';
                errorMsg += '- Node.js: npx http-server\n';
                errorMsg += '그 후 http://localhost:8000/index.html 접속\n\n';
                errorMsg += '에러: ' + (error.message || error);
                alert(errorMsg);
            }
            
            // 먼저 fetch 시도 (HTTP 서버 사용 시)
            fetch('data.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('HTTP error! status: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    processData(data);
                })
                .catch(fetchError => {
                    // fetch 실패 시 XMLHttpRequest 시도 (file:// 프로토콜 대응)
                    console.warn('fetch 실패, XMLHttpRequest로 재시도:', fetchError);
                    var xhr = new XMLHttpRequest();
                    xhr.open('GET', 'data.json', true);
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200 || xhr.status === 0) { // 0은 file:// 프로토콜에서 성공
                                try {
                                    var data = JSON.parse(xhr.responseText);
                                    processData(data);
                                } catch (parseError) {
                                    handleError(parseError, 'XMLHttpRequest (JSON 파싱)');
                                }
                            } else {
                                handleError(new Error('HTTP status: ' + xhr.status), 'XMLHttpRequest');
                            }
                        }
                    };
                    xhr.onerror = function() {
                        handleError(new Error('Network error'), 'XMLHttpRequest');
                    };
                    xhr.send(null);
                });
        }
    </script>
</body>
</html>
